<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard Admin - RamStore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #16a34a;
            --warning: #ea580c;
            --danger: #dc2626;
            --info: #0891b2;
            --light-bg: #f8fafc;
            --dark-text: #1e293b;
            --gray-border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.08);
        }
        
        body {
            font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background-color: var(--light-bg);
            color: var(--dark-text);
        }
        
        /* Sidebar Styling */
        .sidebar {
            width: 250px;
            min-height: 100vh;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-right: 1px solid var(--gray-border);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .sidebar .brand {
            padding: 24px 20px;
            border-bottom: 1px solid var(--gray-border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar .brand i {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .sidebar .brand div {
            line-height: 1.2;
        }
        
        .sidebar .brand small {
            color: var(--secondary);
            font-size: 0.75rem;
        }
        
        .sidebar .nav {
            flex-direction: column;
            padding: 0 8px;
        }
        
        .sidebar .nav-link {
            color: var(--dark-text);
            text-decoration: none;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 4px 0;
        }
        
        .sidebar .nav-link:hover {
            background-color: rgba(37, 99, 235, 0.08);
            color: var(--primary);
        }
        
        .sidebar .nav-link.active {
            background: linear-gradient(90deg, var(--primary), #3b82f6);
            color: white;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        
        .sidebar hr {
            margin: 10px 0;
            border: none;
            height: 1px;
            background-color: var(--gray-border);
        }
        
        /* Main Content */
        .main-wrapper {
            margin-left: 250px;
            width: calc(100% - 250px);
            padding: 24px;
        }
        
        /* Stat Cards */
        .stat-card {
            padding: 24px;
            text-align: center;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .stat-card.bg-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .stat-card.bg-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        
        .stat-card.bg-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .stat-card.bg-info {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* Card Styles */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .card-header {
            background-color: #f8fafc;
            border-bottom: 1px solid var(--gray-border);
            padding: 16px 20px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            min-width: 90px;
        }
        
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-processing { background-color: #dbeafe; color: #1e40af; }
        .status-shipped { background-color: #d1fae5; color: #065f46; }
        .status-delivered { background-color: #ecfdf5; color: #047857; }
        .status-cancelled { background-color: #fee2e2; color: #b91c1c; }
        
        /* Table Styles */
        .table {
            font-size: 0.95rem;
        }
        
        .table thead th {
            background-color: #f8fafc;
            border-bottom: 2px solid var(--gray-border);
            font-weight: 500;
            padding: 16px 20px;
        }
        
        .table tbody td {
            padding: 16px 20px;
            vertical-align: middle;
            border-bottom: 1px solid var(--gray-border);
        }
        
        .table tbody tr:hover {
            background-color: rgba(37, 99, 235, 0.02);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                border-right: none;
                border-bottom: 1px solid var(--gray-border);
            }
            
            .main-wrapper {
                margin-left: 0;
                width: 100%;
            }
            
            .row.g-3 > [class*="col-"] {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }
        
        /* Page Loader */
        #page-loader {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1050;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div id="page-loader">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Memuat…</span>
        </div>
    </div>

    <aside class="sidebar">
        <div class="brand">
            <i class="bi bi-shop"></i>
            <div>
                <div style="font-size:1rem">RamStore</div>
                <small class="text-muted">Admin Panel</small>
            </div>
        </div>
        <nav class="nav p-3">
            <a class="nav-link active" href="dashboard.html">
                <i class="bi bi-speedometer2"></i>Dashboard
            </a>
            <a class="nav-link" href="products.html">
                <i class="bi bi-box-seam"></i>Produk
            </a>
            <a class="nav-link" href="admin-orders.html">
                <i class="bi bi-receipt"></i>Pesanan
            </a>
            <a class="nav-link" href="admin-users.html">
                <i class="bi bi-people"></i>Users
            </a>
            <hr>
            <a class="nav-link" href="index.html">
                <i class="bi bi-house-door"></i>Lihat Toko
            </a>
            <a class="nav-link text-danger" href="#" id="logout-btn">
                <i class="bi bi-box-arrow-right"></i>Logout
            </a>
        </nav>
    </aside>

    <div class="main-wrapper">
        <main class="content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h4"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
            </div>

            <!-- Stats Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card bg-primary">
                        <div class="stat-icon"><i class="bi bi-box-seam"></i></div>
                        <div class="stat-value" id="stat-products">0</div>
                        <div class="stat-label">Total Produk</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card bg-success">
                        <div class="stat-icon"><i class="bi bi-receipt"></i></div>
                        <div class="stat-value" id="stat-orders">0</div>
                        <div class="stat-label">Total Pesanan</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card bg-warning">
                        <div class="stat-icon"><i class="bi bi-people"></i></div>
                        <div class="stat-value" id="stat-users">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card bg-info">
                        <div class="stat-icon"><i class="bi bi-cash-coin"></i></div>
                        <div class="stat-value" id="stat-revenue">Rp 0</div>
                        <div class="stat-label">Pendapatan</div>
                    </div>
                </div>
            </div>

            <!-- Order Status -->
            <div class="row g-3 mb-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Status Pesanan</h5>
                            <button class="btn btn-sm btn-outline-primary">Refresh</button>
                        </div>
                        <div class="card-body p-0">
                            <div id="order-status-list"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Pesanan Terbaru</h5>
                            <a href="admin-orders.html" class="btn btn-sm btn-outline-primary">Lihat Semua</a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-orders"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Users -->
            <div class="row g-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-people me-2"></i>Users Terbaru</h5>
                            <a href="admin-users.html" class="btn btn-sm btn-outline-primary">Kelola Users</a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Username</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Bergabung</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-users"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function hidePageLoader() {
            const loader = document.getElementById('page-loader');
            if (loader) loader.style.display = 'none';
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }

        async function loadDashboardData() {
            try {
                // Load products count
                const productsRes = await fetch('api/api.php?action=get_products');
                const products = await productsRes.json();
                document.getElementById('stat-products').textContent = products.length;

                // Load orders stats
                // Try to load order stats from server; if server requires auth, fall back to localStorage orders
                try {
                    const ordersRes = await fetch('api/orders.php?action=get_order_stats');
                    if (ordersRes.ok) {
                        const stats = await ordersRes.json();
                        document.getElementById('stat-orders').textContent = stats.total_orders || 0;
                        document.getElementById('stat-revenue').textContent = 'Rp ' + formatPrice(stats.revenue || 0);

                        // Display order status breakdown
                        const statusList = document.getElementById('order-status-list');
                        statusList.innerHTML = Object.entries(stats.orders_by_status || {}).map(([status, count]) => `
                            <div style="display:flex;justify-content:space-between;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #e5e7eb">
                                <span>${getStatusLabel(status)}</span>
                                <strong>${count}</strong>
                            </div>
                        `).join('');
                    } else {
                        // fallback: compute from localStorage orders
                        const localOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                        const totals = localOrders.length;
                        const revenue = localOrders.reduce((s,o)=>s+(o.totals?.total||0),0);
                        document.getElementById('stat-orders').textContent = totals;
                        document.getElementById('stat-revenue').textContent = 'Rp ' + formatPrice(revenue || 0);
                        const statusCounts = {};
                        localOrders.forEach(o=>{ statusCounts[o.status] = (statusCounts[o.status]||0)+1; });
                        const statusList = document.getElementById('order-status-list');
                        statusList.innerHTML = Object.entries(statusCounts).map(([status,count])=>`
                            <div style="display:flex;justify-content:space-between;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #e5e7eb">
                                <span>${getStatusLabel(status)}</span>
                                <strong>${count}</strong>
                            </div>
                        `).join('');
                    }
                } catch(e) {
                    console.warn('Order stats fetch failed, falling back to localStorage', e);
                    const localOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                    const totals = localOrders.length;
                    const revenue = localOrders.reduce((s,o)=>s+(o.totals?.total||0),0);
                    document.getElementById('stat-orders').textContent = totals;
                    document.getElementById('stat-revenue').textContent = 'Rp ' + formatPrice(revenue || 0);
                    const statusCounts = {};
                    localOrders.forEach(o=>{ statusCounts[o.status] = (statusCounts[o.status]||0)+1; });
                    const statusList = document.getElementById('order-status-list');
                    statusList.innerHTML = Object.entries(statusCounts).map(([status,count])=>`
                        <div style="display:flex;justify-content:space-between;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #e5e7eb">
                            <span>${getStatusLabel(status)}</span>
                            <strong>${count}</strong>
                        </div>
                    `).join('');
                }

                // Load recent orders — prefer server but fall back to localStorage
                try {
                    const allOrdersRes = await fetch('api/orders.php?action=get_all_orders');
                    if (allOrdersRes.ok) {
                        const allOrders = await allOrdersRes.json();
                        const recent = allOrders.slice(0, 5);
                        document.getElementById('recent-orders').innerHTML = recent.map(order => `
                            <tr onclick="window.location.href='order-detail.html?id=${order.id}'" style="cursor:pointer">
                                <td><strong>${order.order_id}</strong></td>
                                <td>${order.customer_name || order.username || ''}</td>
                                <td>Rp ${formatPrice(order.total)}</td>
                                <td><span class="status-badge status-${order.status}">${getStatusLabel(order.status)}</span></td>
                            </tr>
                        `).join('');
                    } else {
                        const localOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                        const recent = localOrders.slice(-5).reverse();
                        document.getElementById('recent-orders').innerHTML = recent.map(order => `
                            <tr>
                                <td><strong>${order.order_id || order.order_id}</strong></td>
                                <td>${order.customer?.name || ''}</td>
                                <td>Rp ${formatPrice(order.totals?.total || 0)}</td>
                                <td><span class="status-badge status-${order.status || 'pending'}">${getStatusLabel(order.status || 'pending')}</span></td>
                            </tr>
                        `).join('');
                    }
                } catch(e) {
                    console.warn('Recent orders fetch failed, using localStorage', e);
                    const localOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                    const recent = localOrders.slice(-5).reverse();
                    document.getElementById('recent-orders').innerHTML = recent.map(order => `
                        <tr>
                            <td><strong>${order.order_id || ''}</strong></td>
                            <td>${order.customer?.name || ''}</td>
                            <td>Rp ${formatPrice(order.totals?.total || 0)}</td>
                            <td><span class="status-badge status-${order.status || 'pending'}">${getStatusLabel(order.status || 'pending')}</span></td>
                        </tr>
                    `).join('');
                }

                // Load recent users from public API we added
                try {
                    const usersRes = await fetch('api/api.php?action=get_users');
                    if (usersRes.ok) {
                        const users = await usersRes.json();
                        document.getElementById('stat-users').textContent = users.length;
                        const recent = users.slice(0, 5);
                        document.getElementById('recent-users').innerHTML = recent.map(user => `
                            <tr>
                                <td><strong>${user.name || user.username || ''}</strong></td>
                                <td>${user.email || ''}</td>
                                <td><span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-secondary'}">${user.role || 'user'}</span></td>
                                <td>${user.joined ? new Date(user.joined).toLocaleDateString('id-ID') : '-'}</td>
                            </tr>
                        `).join('');
                    } else {
                        // fallback: show counts from localStorage users (if any)
                        const localUsers = JSON.parse(localStorage.getItem('users') || '[]');
                        document.getElementById('stat-users').textContent = localUsers.length;
                        const recent = localUsers.slice(-5).reverse();
                        document.getElementById('recent-users').innerHTML = recent.map(user => `
                            <tr>
                                <td><strong>${user.username || user.name || ''}</strong></td>
                                <td>${user.email || ''}</td>
                                <td><span class="badge bg-secondary">${user.role || 'user'}</span></td>
                                <td>${user.created_at ? new Date(user.created_at).toLocaleDateString('id-ID') : '-'}</td>
                            </tr>
                        `).join('');
                    }
                } catch(e) {
                    console.warn('Users fetch failed, falling back to localStorage', e);
                    const localUsers = JSON.parse(localStorage.getItem('users') || '[]');
                    document.getElementById('stat-users').textContent = localUsers.length;
                    const recent = localUsers.slice(-5).reverse();
                    document.getElementById('recent-users').innerHTML = recent.map(user => `
                        <tr>
                            <td><strong>${user.username || user.name || ''}</strong></td>
                            <td>${user.email || ''}</td>
                            <td><span class="badge bg-secondary">${user.role || 'user'}</span></td>
                            <td>${user.created_at ? new Date(user.created_at).toLocaleDateString('id-ID') : '-'}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            } finally {
                hidePageLoader();
            }
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Menunggu Konfirmasi',
                'processing': 'Sedang Diproses',
                'shipped': 'Sedang Dikirim',
                'delivered': 'Terkirim',
                'cancelled': 'Dibatalkan'
            };
            return labels[status] || status;
        }

        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Yakin ingin logout?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        });

        loadDashboardData();
    </script>
</body>
</html>